---
version: 2
aliases:
  - &restore-npm-cache
    key: dependency-cache-{{ checksum "package.json" }}

  - &save-npm-cache
    key: dependency-cache-{{ checksum "package.json" }}
    paths:
      - /home/ubuntu/nvm/versions/node/10.11.0/bin
      - /home/ubuntu/nvm/versions/node/10.11.0/lib/node_modules
      - ./node_modules
      - ./packages/cfa-styleguide/node_modules
      - ./packages/forms/node_modules
      - ./packages/web-ui/node_modules


jobs:
  test:
    docker: # run the steps with Docker
      - image: circleci/node:10.11.0
    steps: # a collection of executable commands
      - checkout # special step to check out source code to working directory
      - run:
          name: update-npm
          command: 'sudo npm install -g npm@latest lerna'
      - restore_cache: *restore-npm-cache
      - run:
          name: install npm packages
          command: npm install && lerna bootstrap
      - run:
          name: build
          command: npx tsc -b packages --incremental && npm run test
      - save_cache: *save-npm-cache

  deploy:
    docker: # run the steps with Docker
      - image: circleci/node:10.11.0
    steps:
      - checkout
      - restore_cache: *restore-npm-cache
      - run:
          name: install npm packages
          command: npm install && lerna bootstrap
      - run:
          name: build react web ui
          command: lerna run build
      - add_ssh_keys:
          fingerprints:
            - "4a:dc:3f:53:18:b6:fe:8c:69:a6:e7:b3:02:55:5a:f0"
      - run:
          name: deploy react web ui
          command: |
            gh-pages --dist packages/web-ui/build --message "Build Site

            $(date)
            $(git rev-parse HEAD)
            [skip ci]"
      - save_cache: *save-npm-cache


workflows:
  version: 2
  run_tests:
    jobs:
      - test
  deploy:
    jobs:
      - test:
          filters:
            branches:
              only: master
      - deploy:
          requires:
            - test
          filters:
            branches:
              only: master
